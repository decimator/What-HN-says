<html>
<head>
<script>
  function getStory(url, callback) {
    //console.log("Started getting story: " + url);
    var currentTime = new Date().getTime();

    // HN search API: http://www.hnsearch.com/api
    var req = new XMLHttpRequest();
    req.open(
        "GET",
        "http://api.thriftdb.com/api.hnsearch.com/items/_search" +
        "?weights[title]=0.0&weights[text]=0.0&weights[url]=1.0" +
        "&weights[domain]=0.0&weights[username]=0.0&weights[type]=0.0" +
        "&q=" + encodeURIComponent(url),
        true);
    req.onload = parseJSON;
    req.send(null);

    function parseJSON() {
      //console.log("Finished getting story, took ms: " + (new Date().getTime() - currentTime));
      var text = req.responseText;
      var json = !(/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(
          text.replace(/"(\\.|[^"\\])*"/g, ''))) && eval('(' + text + ')');
      var result0 = json.results[0];
      if (result0) {
        callback(result0.item);
      } else {
        callback(null);
      }
    }
  }

  function createIconImageData(points) {
    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext('2d');

    // Fill the canvas with HN background grey
    ctx.strokeStyle = "#F60";
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, 19, 19);

    // Draw triangle filled with HN grey
    ctx.fillStyle = "#9A9A9A";
    ctx.beginPath();
    ctx.moveTo(6, 16);
    ctx.lineTo(9, 10);
    ctx.lineTo(10, 10);
    ctx.lineTo(13, 16);
    ctx.fill();

    if (points > 999) {
      points = 999;
    }

    // Draw points counter
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.font="6pt Verdana";
    ctx.fillText(points, 9, 9, 19);
    
    // Return ImageData from canvas
    return ctx.getImageData(0, 0, 19, 19);
  }

  function updateIcon(points, tabId) {
    chrome.pageAction.setIcon({"imageData": createIconImageData(points), "tabId": tabId});
    chrome.pageAction.show(tabId);
  }

  function startsWith(data, input) {
    return data.substring(0, input.length) === input;
  }

  stories = {}

  chrome.pageAction.onClicked.addListener(function(tab) {
    var story = stories[tab.id];
    if (story) {
      var url = "http://news.ycombinator.com/item?id=" + story.id;
      chrome.tabs.create({'url': url}, function(tab) {
        // Tab opened
      });
    }
  });

  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if (!startsWith(tab.url, 'chrome://') &&
        !startsWith(tab.url, 'http://news.ycombinator.com') &&
        changeInfo.status == 'complete') {
      function updateState(story) {
        if (story) {
          updateIcon(story.points, tabId);
          stories[tabId] = story;
        } else {
          // Story not found on HN
        }
      }

      getStory(tab.url, updateState);
    }
  });
</script>
</head>
</html>
